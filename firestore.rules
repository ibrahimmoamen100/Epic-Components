rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to validate product sizes
    function validateProductSizes(requestData) {
      let sizes = requestData.sizes;
      let basePrice = requestData.price;
      
      return 
        // Allow if sizes is null or empty list
        (sizes == null || sizes.size() == 0) ||
        
        // If sizes exist:
        (
          sizes is list &&
          
          // Validate first size (index 0) has extraPrice == 0
          (sizes.size() > 0 ? sizes[0].extraPrice == 0 : true) &&
          
          // Validate all sizes have required fields
          sizes.hasAll(['label', 'extraPrice', 'price'])
        );
    }
    
    // Helper function to check if vendorName is being modified
    function isVendorNameUnchanged(existingData, newData) {
      // For new documents, vendorName can be set
      return !existingData.exists() ||
             // For updates, vendorName must not change OR must be absent from update
             !('vendorName' in newData.diff(existingData).affectedKeys());
    }
    
    // Check if user is admin
    function isAdmin() {
      return request.auth != null && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Check if user is vendor owner
    function isVendorOwner(vendorId) {
      return request.auth != null && 
             get(/databases/$(database)/documents/vendors/$(vendorId)).data.authUid == request.auth.uid;
    }

    // Products Collection
    match /products/{productId} {
      // Anyone can read products
      allow read: if true;
      
      // Admins can do anything
      allow create, update: if 
        isAdmin() &&
        validateProductSizes(request.resource.data);
      
      allow delete: if isAdmin();
      
      // Vendors can create/update their own products
      // BUT cannot directly modify vendorName field
      allow create: if 
        request.auth != null &&
        request.resource.data.vendorId != null &&
        isVendorOwner(request.resource.data.vendorId) &&
        validateProductSizes(request.resource.data);
      
      allow update: if 
        request.auth != null &&
        resource.data.vendorId != null &&
        isVendorOwner(resource.data.vendorId) &&
        validateProductSizes(request.resource.data) &&
        // CRITICAL: Prevent vendors from changing vendorName
        isVendorNameUnchanged(resource, request.resource);
      
      allow delete: if 
        request.auth != null &&
        resource.data.vendorId != null &&
        isVendorOwner(resource.data.vendorId);
    }
    
    // Vendors Collection
    match /vendors/{vendorId} {
      // Anyone can read vendor info
      allow read: if true;
      
      // Admins can do anything
      allow create, update, delete: if isAdmin();
      
      // Vendors can update their own profile
      allow update: if 
        request.auth != null &&
        resource.data.authUid == request.auth.uid;
    }
    
    // Sync Logs Collection (Cloud Functions only)
    match /syncLogs/{logId} {
      // Admins can read sync logs
      allow read: if isAdmin();
      
      // Only Cloud Functions can write (no client writes)
      allow write: if false;
    }
    
    // Users Collection
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
